<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTD Serwis - Najmy w trakcie (ERP)</title>
    
    <!-- Biblioteki Zewnętrzne -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           KONFIGURACJA UI I MOTYWU BAZOWEGO
           ========================================= */
        :root {
            --bg-body: #f8fafc;
            --bg-sidebar: #0f172a;
            --sidebar-hover: #1e293b;
            --accent-blue: #0284c7;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;

            --dark-panel: #0f1419;
            --dark-input: #1a1f26;
            --dark-border: #2a3136;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* =========================================
           SIDEBAR (ZGODNY Z ERP - NIENARUSZONY)
           ========================================= */
        .sidebar { width: 280px; background-color: var(--bg-sidebar); color: white; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; box-shadow: 4px 0 15px rgba(0,0,0,0.15); }
        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .sidebar-header { padding: 35px 25px; font-size: 24px; font-weight: 900; border-bottom: 1px solid rgba(255,255,255,0.05); letter-spacing: -0.5px; }
        .sidebar-header span { color: var(--accent-blue); }
        
        .nav-menu { flex: 1; padding: 20px 0; }
        .nav-item { padding: 12px 25px; margin: 2px 12px; border-radius: 10px; display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; font-weight: 500; font-size: 14px; transition: 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover { background-color: var(--sidebar-hover); color: white; }
        .nav-item.active { background-color: rgba(2, 132, 199, 0.15); color: white; border-left-color: var(--accent-blue); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }

        .submenu { background-color: rgba(0,0,0,0.2); margin-bottom: 5px; padding: 5px 0; display: none; }
        .submenu-label { padding: 12px 25px 5px 55px; font-size: 10px; text-transform: uppercase; color: #475569; font-weight: 800; letter-spacing: 1px; }
        .submenu-item { padding: 8px 25px 8px 55px; display: block; color: #94a3b8; text-decoration: none; font-size: 13px; transition: 0.2s; border-left: 3px solid transparent;}
        .submenu-item:hover { color: white; background-color: var(--sidebar-hover); }
        .submenu-item.active { color: white; font-weight: 700; border-left-color: var(--accent-blue); }

        /* =========================================
           TOPBAR & WRAPPER
           ========================================= */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { background: white; padding: 0 40px; height: 80px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10; }
        .search-bar { background: #f1f5f9; padding: 10px 18px; border-radius: 10px; display: flex; align-items: center; gap: 12px; width: 350px; }
        .search-bar input { border: none; background: transparent; outline: none; width: 100%; font-size: 14px; font-weight: 500; }
        
        .content-area { padding: 40px; overflow-y: auto; flex: 1; position: relative; }
        .view-panel { display: none; animation: fadeIn 0.4s ease; }
        .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BAZOWE ELEMENTY BAZY DANYCH */
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 12px; }
        .card { background: white; border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px; overflow: hidden; transition: 0.3s; }
        .card-header { padding: 20px 30px; border-bottom: 1px solid var(--border-color); background: #fcfcfd; font-size: 14px; font-weight: 800; color: var(--accent-blue); text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.5px; }
        .card-body { padding: 30px; }

        /* TABELA */
        table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
        th { padding: 15px 20px; background-color: #f8fafc; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 11px; border-bottom: 2px solid var(--border-color); }
        td { padding: 18px 20px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; }
        tr:hover td { background-color: #f8fafc; cursor: pointer; }

        .status-badge { padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 900; text-transform: uppercase; display: inline-block; }
        .st-active { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .st-delayed { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; animation: pulse 2s infinite;}
        .st-breakdown { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        .reg-badge { background: #1e293b; color: #fff; padding: 4px 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 800; font-size: 14px; letter-spacing: 1px; display: inline-block; text-transform: uppercase; }

        /* BUTTONY */
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; box-shadow: 0 4px 10px rgba(2, 132, 199, 0.2); }
        .btn-primary:hover { background: #0369a1; transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-small { padding: 6px 12px; font-size: 11px; }

        /* =========================================
           KREATOR WYNJAMU I ZWROTU 
           ========================================= */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.full-width { grid-column: 1 / -1; }
        
        .creator-label { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .required::after { content: '*'; color: var(--danger); margin-left: 4px; font-size: 14px; }
        
        .creator-input { padding: 14px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; color: var(--text-main); background: white; outline: none; transition: 0.3s; font-family: inherit; width: 100%; }
        .creator-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        textarea.creator-input { resize: vertical; min-height: 80px; }
        .creator-input[readonly] { background: #f1f5f9; color: var(--text-muted); cursor: not-allowed; font-weight: bold; border-color: transparent; }

        /* Przełączniki i Checkboxy */
        .context-switch { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 15px 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .context-label { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 700; cursor: pointer; color: var(--text-main); transition: 0.2s; }
        .context-label input { width: 18px; height: 18px; accent-color: var(--accent-blue); cursor: pointer; }
        .hidden-section { display: none !important; }

        .type-switch { display: flex; background: #f1f5f9; padding: 5px; border-radius: 10px; border: 1px solid var(--border-color); width: max-content; margin-bottom: 25px; }
        .type-option { padding: 10px 25px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; color: var(--text-muted); transition: 0.2s; user-select: none; }
        .type-option.active { background: white; color: var(--accent-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .foreigner-box, .rep-section { display: none; background: #f0fdfa; padding: 20px; border-radius: 10px; border: 1px dashed var(--success); margin-bottom: 20px; animation: fadeIn 0.3s; }
        .foreigner-box { background: #fffbeb; border-color: var(--warning); margin-top: 10px; }
        .company-box { display: none; background: #f0fdfa; padding: 25px; border-radius: 10px; border: 1px solid #ccfbf1; margin-bottom: 20px; animation: fadeIn 0.3s; }
        .foreigner-box.active, .rep-section.active { display: grid; }
        .company-box.active { display: block; }

        /* Oświadczenia TU */
        .statement-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 1024px) { .statement-list { grid-template-columns: 1fr; } }
        .statement-item { display: flex; align-items: flex-start; gap: 12px; padding: 15px; border: 1px solid var(--border-color); border-radius: 10px; background: #f8fafc; transition: 0.2s; cursor: pointer; }
        .statement-item:hover { border-color: var(--accent-blue); background: #f0f9ff; }
        .statement-item input[type="checkbox"], .statement-item input[type="radio"] { width: 18px; height: 18px; accent-color: var(--accent-blue); margin-top: 2px; cursor: pointer; }
        .statement-content { flex: 1; }
        .statement-title { font-weight: 700; font-size: 13.5px; margin-bottom: 4px; color: var(--text-main); }
        .statement-desc { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
        .statement-input { margin-top: 10px; width: 100%; display: none; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px;}
        .statement-item:has(input:checked) .statement-input { display: block; }
        .statement-item:has(input:checked) { border-color: var(--accent-blue); background: #f0f9ff; box-shadow: 0 4px 10px rgba(2, 132, 199, 0.05); }
        
        .other-vehicles-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .other-vehicle-row { display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; }

        /* Specjalne / Wskaźniki Paliwa */
        .special-box { display: none; background: #fff7ed; border: 1px solid #fed7aa; padding: 20px; border-radius: 10px; margin-top: 15px; animation: fadeIn 0.3s; }
        .special-box.active { display: block; }
        .rate-highlight { font-size: 20px; font-weight: 900; color: #b45309; }
        
        .equip-spec-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .equip-spec-item { display: flex; align-items: center; gap: 8px; background: white; border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; color: var(--text-main); }
        .equip-spec-item:hover { border-color: var(--accent-blue); }
        .equip-spec-item input { width: 16px; height: 16px; accent-color: var(--accent-blue); cursor: pointer; }

        .fuel-wrapper { background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .fuel-gauge, .lpg-gauge { display: flex; gap: 2px; height: 40px; margin-top: 5px; margin-bottom: 5px; }
        .fuel-segment, .lpg-segment { flex: 1; background: #e2e8f0; border-radius: 4px; cursor: pointer; transition: 0.2s; border: 1px solid #cbd5e1; }
        .fuel-segment:hover, .lpg-segment:hover { background: #94a3b8; }
        .fuel-segment.active { background: var(--accent-blue); border-color: #0369a1; }
        .fuel-segment.active.low { background: var(--danger); border-color: #b91c1c; }
        .fuel-segment.active.mid { background: var(--warning); border-color: #b45309; }
        .lpg-segment.active { background: var(--success); border-color: #047857; }
        .lpg-segment.active.low { background: var(--danger); border-color: #b91c1c; }
        .lpg-segment.active.mid { background: var(--warning); border-color: #b45309; }
        .fuel-labels { display: flex; justify-content: space-between; font-size: 11px; font-weight: 800; color: var(--text-muted); padding: 0 5px; text-transform: uppercase;}
        .fuel-info-value { font-size: 20px; font-weight: 900; color: var(--text-main); margin-left: 10px; min-width: 60px; text-align: right; }

        /* INTERAKTYWNY SCHEMAT AUTA */
        .schema-container { display: flex; gap: 40px; background: white; padding: 30px; border: 1px solid var(--border-color); border-radius: 12px; align-items: stretch; }
        @media (max-width: 900px) { .schema-container { flex-direction: column; } }
        
        .car-map { position: relative; width: 240px; height: 480px; margin: 0 auto; background: #f1f5f9; border-radius: 45px; border: 4px solid #cbd5e1; flex-shrink: 0; box-shadow: inset 0 0 15px rgba(0,0,0,0.05); }
        .car-windshield { position: absolute; top: 22%; left: 15%; width: 70%; height: 10%; background: #94a3b8; border-radius: 10px 10px 0 0; opacity: 0.5; pointer-events: none;}
        .car-rear-window { position: absolute; bottom: 22%; left: 15%; width: 70%; height: 8%; background: #94a3b8; border-radius: 0 0 10px 10px; opacity: 0.5; pointer-events: none;}
        .car-roof { position: absolute; top: 32%; left: 15%; width: 70%; height: 38%; background: #cbd5e1; opacity: 0.5; pointer-events: none;}

        .car-part { position: absolute; background: rgba(255,255,255,0.95); border: 1px dashed #64748b; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: #475569; text-align: center; padding: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .car-part:hover { background: rgba(239, 68, 68, 0.1); z-index: 10; border-style: solid; border-color: var(--danger); transform: scale(1.05); }
        .car-part.damaged { background: rgba(239, 68, 68, 0.95); border: 2px solid #b91c1c; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 5; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); }
        
        .p-front-bumper { top: -2%; left: 10%; width: 80%; height: 8%; border-radius: 20px 20px 0 0; }
        .p-hood { top: 7%; left: 15%; width: 70%; height: 14%; }
        .p-fender-fl { top: 7%; left: -3%; width: 17%; height: 16%; border-radius: 10px 0 0 0; }
        .p-fender-fr { top: 7%; right: -3%; width: 17%; height: 16%; border-radius: 0 10px 0 0; }
        .p-door-fl { top: 24%; left: -3%; width: 17%; height: 22%; }
        .p-door-fr { top: 24%; right: -3%; width: 17%; height: 22%; }
        .p-door-rl { top: 47%; left: -3%; width: 17%; height: 22%; }
        .p-door-rr { top: 47%; right: -3%; width: 17%; height: 22%; }
        .p-fender-rl { top: 70%; left: -3%; width: 17%; height: 16%; border-radius: 0 0 0 10px; }
        .p-fender-rr { top: 70%; right: -3%; width: 17%; height: 16%; border-radius: 0 0 10px 0; }
        .p-roof-box { top: 32%; left: 25%; width: 50%; height: 38%; border-radius: 6px; background: transparent; }
        .p-trunk { top: 71%; left: 15%; width: 70%; height: 14%; }
        .p-rear-bumper { bottom: -2%; left: 10%; width: 80%; height: 8%; border-radius: 0 0 20px 20px; }

        .damage-list-area { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .upload-zone { border: 2px dashed var(--accent-blue); border-radius: 10px; padding: 30px; text-align: center; background: #f0f9ff; cursor: pointer; transition: 0.2s; }
        .upload-zone:hover { background: #e0f2fe; border-color: #0284c7; }

        /* Kary Umowne */
        .penalties-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .penalty-item { display: flex; justify-content: space-between; align-items: center; background: #fffbeb; border: 1px solid #fde68a; padding: 12px 18px; border-radius: 8px; font-size: 13.5px; color: #92400e; transition: 0.2s; font-weight: 500; cursor: pointer;}
        .penalty-item:hover { background: #fef3c7; }
        .penalty-item input { width: 18px; height: 18px; accent-color: var(--danger); cursor: pointer; margin-right: 15px;}
        .penalty-item.applied { background: #fef2f2; border-color: #fca5a5; color: #991b1b; }
        .penalty-price { font-weight: 800; margin-left: auto; font-size: 14px; }
        .btn-remove-penalty { background: transparent; border: none; color: var(--danger); cursor: pointer; width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 15px; margin-left: 10px;}
        .btn-remove-penalty:hover { background: #fee2e2; }

        /* Modale */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 600px; max-width: 90vw; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow: hidden; }
        .modal-header { padding: 20px 30px; background: #f8fafc; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 800; color: var(--text-dark); }
        .modal-body { padding: 30px; max-height: 80vh; overflow-y: auto;}

        /* Chipsy w Modalach */
        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { padding: 8px 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; user-select: none; }
        .chip.active { background: var(--accent-blue); color: white; border-color: #0284c7; }

        /* ELEMENTY PROTOKOŁU ZWROTU */
        .comparison-box { background: #f8fafc; border: 1px dashed var(--text-muted); padding: 12px 18px; border-radius: 8px; font-size: 13px; color: var(--text-muted); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .comparison-box strong { color: var(--text-dark); font-size: 15px; }

        .summary-dashboard { background: #1e293b; color: white; border-radius: 12px; padding: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 20px;}
        .summary-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; }
        .summary-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; font-weight: 800; margin-bottom: 8px; display: block; letter-spacing: 0.5px;}
        .summary-val { font-size: 22px; font-weight: 900; color: white; display: block; }
        .summary-val.highlight { color: #38bdf8; }
        .summary-val.warn { color: #f87171; }
        .invoice-box { background: linear-gradient(135deg, var(--accent-blue), #0369a1); padding: 25px; border-radius: 10px; grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
        
        .bypass-box { display: flex; align-items: center; gap: 12px; background: white; padding: 20px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.02); transition: 0.2s; margin-bottom: 25px;}
        .bypass-box:hover { border-color: var(--warning); background: #fffbeb; }
        .bypass-box input { width: 22px; height: 22px; accent-color: var(--warning); cursor: pointer; }
        .hidden-card { display: none !important; }

        /* Karty Detali Najmu */
        .details-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        @media (max-width: 1100px) { .details-grid { grid-template-columns: 1fr; } }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 8px; }
        .info-label { color: var(--text-muted); font-weight: 600; }
        .info-value { font-weight: 700; color: var(--text-main); text-align: right; }

        /* Timeline / Oś Czasu */
        .card-timeline { position: relative; padding-left: 30px; border-left: 2px solid var(--border-color); margin-left: 10px; margin-top: 20px; }
        .card-tl-item { background: #f8fafc; border: 1px solid var(--border-color); padding: 15px; border-radius: 10px; margin-bottom: 15px; position: relative; }
        .card-tl-item::before { content: ''; position: absolute; left: -39px; top: 18px; width: 14px; height: 14px; background: white; border: 3px solid var(--accent-blue); border-radius: 50%; }
        
        .card-tl-cat { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; margin-bottom: 8px; display: inline-block; }
        .cat-serwis { background: #d1fae5; color: #065f46; }
        .cat-naprawa { background: #fef3c7; color: #92400e; }
        .cat-szkoda { background: #fee2e2; color: #991b1b; }
        .cat-inne { background: #e2e8f0; color: #475569; }

    </style>
</head>
<body>

    <!-- SIDEBAR KOMPLETNY (NIENARUSZONY) -->
    <div class="sidebar">
        <div class="sidebar-header"><span>DTD</span> Serwis</div>
        <div class="nav-menu">
            <a href="index.html" class="nav-item"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a href="szkody.html" class="nav-item"><i class="fa-solid fa-clipboard-list"></i> Lista Szkód</a>
            
            <div class="nav-item active has-submenu" onclick="toggleSubmenu('submenu-samochody')">
                <div style="display:flex; align-items:center; gap:12px;"><i class="fa-solid fa-car"></i> Samochody</div>
                <i class="fa-solid fa-chevron-down" id="icon-samochody" style="font-size: 10px; transform: rotate(180deg);"></i>
            </div>
            <div class="submenu" id="submenu-samochody" style="display: block;">
                <div class="submenu-label">Najmy</div>
                <a href="najmy_trwajace.html" class="submenu-item active">Najmy w trakcie</a>
                <a href="najmy_zaplanowane.html" class="submenu-item">Najmy zaplanowane</a>
                <a href="najmy_archiwum.html" class="submenu-item">Najmy zakończone (Archiwum)</a>
                <div class="submenu-label">Flota własna</div>
                <a href="flota_jezdzace.html" class="submenu-item">Pojazdy jeżdżące</a>
                <a href="flota_sprzedane.html" class="submenu-item">Sprzedane / Zezłom.</a>
                <a href="flota_podnajete.html" class="submenu-item">Pojazdy podnajęte</a>
                <a href="flota_podnajete_arch.html" class="submenu-item">Podnajęte - Archiwum</a>
            </div>

            <a href="holowania.html" class="nav-item"><i class="fa-solid fa-truck-pickup"></i> Holowania</a>
            <a href="ogledziny.html" class="nav-item"><i class="fa-solid fa-magnifying-glass"></i> Oględziny</a>
            <a href="dane.html" class="nav-item"><i class="fa-solid fa-database"></i> Dane</a>
            <a href="magazyn.html" class="nav-item"><i class="fa-solid fa-boxes-stacked"></i> Magazyn i części</a>
            <a href="rozliczenia.html" class="nav-item"><i class="fa-solid fa-file-invoice-dollar"></i> Rozliczenia</a>
            <a href="dzial_prawny.html" class="nav-item"><i class="fa-solid fa-scale-balanced"></i> Dział prawny</a>
            
            <div class="nav-item has-submenu" onclick="toggleSubmenu('submenu-naprawy')">
                <div style="display:flex; align-items:center; gap:12px;"><i class="fa-solid fa-wrench"></i> Naprawy</div>
                <i class="fa-solid fa-chevron-down" id="icon-naprawy" style="font-size: 10px;"></i>
            </div>
            <div class="submenu" id="submenu-naprawy">
                <a href="naprawy_blacharnia.html" class="submenu-item">Warsztat blacharsko-lakierniczy</a>
                <a href="naprawy_elektronika.html" class="submenu-item">Warsztat elektroniki pojazdowej</a>
                <a href="naprawy_mechanika.html" class="submenu-item">Warsztat mechaniczny</a>
                <a href="naprawy_inne.html" class="submenu-item">Inne naprawy</a>
            </div>

            <a href="dokumenty.html" class="nav-item"><i class="fa-solid fa-file-pdf"></i> Generator dokumentów</a>
        </div>
    </div>

    <!-- MAIN WRAPPER -->
    <div class="main-wrapper">
        <div class="topbar">
            <div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" placeholder="Szukaj umowy, klienta, VIN..."></div>
            <div class="user-info">
                <i class="fa-regular fa-bell" style="font-size:20px; cursor:pointer; color:var(--text-muted); margin-right:20px;"></i>
                <span style="font-weight:700;">admin@dtdserwis.pl</span>
            </div>
        </div>

        <div class="content-area">

            <!-- WIDOK 1: LISTA TRWAJĄCYCH NAJMÓW -->
            <div id="view-list" class="view-panel active">
                <div class="header-actions">
                    <div class="page-title"><i class="fa-solid fa-key" style="color:var(--accent-blue)"></i> Wydane Pojazdy (Najmy Trwające)</div>
                    <button class="btn btn-primary" onclick="toggleViews('view-form')"><i class="fa-solid fa-plus-circle"></i> Nowy Wynajem (Wydaj Auto)</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Nr Umowy / Kontekst</th>
                                <th>Dane Najemcy</th>
                                <th>Pojazd Wydany</th>
                                <th>Data Wydania</th>
                                <th>Szac. Zwrot</th>
                                <th>Status / Dni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr onclick="showRentDetails('UM-2026/03/01')">
                                <td><strong>UM-2026/03/01</strong><br><small class="text-muted">OC Sprawcy (PZU)</small></td>
                                <td>Jan Kowalski<br><small class="text-muted">Powiązana szkoda: DTD-2026-090</small></td>
                                <td><span class="reg-badge">WA 12345</span><br>Toyota Yaris (B)</td>
                                <td>01.03.2026 10:00</td>
                                <td>15.03.2026</td>
                                <td><span class="status-badge st-active">Trwa (Dzień 1)</span></td>
                            </tr>
                            <tr onclick="showRentDetails('UM-2026/02/14')">
                                <td><strong>UM-2026/02/14</strong><br><small class="text-muted">Prywatny</small></td>
                                <td>Firma Transportowa XYZ<br><small class="text-muted">NIP: 1112223334</small></td>
                                <td><span class="reg-badge">WX 99881</span><br>Skoda Octavia (C)</td>
                                <td>14.02.2026 08:30</td>
                                <td>28.02.2026</td>
                                <td><span class="status-badge st-delayed">Opóźniony zwrot!</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- WIDOK 2: KARTA DETALI NAJMU -->
            <div id="view-details" class="view-panel">
                <div class="header-actions">
                    <div class="page-title"><i class="fa-solid fa-file-contract"></i> Szczegóły Umowy: <span id="detail-nr" style="color:var(--accent-blue)">UM-2026/03/01</span></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary" onclick="toggleViews('view-list')"><i class="fa-solid fa-arrow-left"></i> Wróć</button>
                        <button class="btn btn-secondary"><i class="fa-solid fa-print"></i> Drukuj Kopię</button>
                        
                        <!-- NOWOŚĆ: Zgłoszenie awarii -->
                        <button class="btn btn-danger" onclick="openBreakdownModal()"><i class="fa-solid fa-car-burst"></i> Zgłoś Awarię / Kolizję</button>
                        
                        <!-- PRZYCISK ZWROTU -->
                        <button class="btn btn-success" onclick="toggleViews('view-return')"><i class="fa-solid fa-arrow-right-to-bracket"></i> Zakończ Najem (Odbierz)</button>
                    </div>
                </div>

                <div class="details-grid">
                    <div class="left-col">
                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-user"></i> Informacje o Najemcy</div>
                            <div class="card-body">
                                <div class="info-row"><div class="info-label">Imię i Nazwisko:</div><div class="info-value">Jan Kowalski</div></div>
                                <div class="info-row"><div class="info-label">PESEL:</div><div class="info-value">85010112345</div></div>
                                <div class="info-row"><div class="info-label">Adres:</div><div class="info-value">ul. Zmyślona 14/2, Warszawa</div></div>
                                <div class="info-row"><div class="info-label">Prawo Jazdy:</div><div class="info-value">12345/WA/21</div></div>
                                <div style="border-top:1px solid var(--border-light); margin:15px 0;"></div>
                                <div class="info-row"><div class="info-label">Kontekst Najmu:</div><div class="info-value" style="color:var(--accent-blue)">OC Sprawcy (PZU)</div></div>
                                <div class="info-row"><div class="info-label">Powiązana Szkoda:</div><div class="info-value"><a href="szkody.html" style="color:var(--accent-blue); font-weight:800;">DTD-2026-090</a></div></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-car"></i> Wydany Pojazd i Stan Początkowy</div>
                            <div class="card-body">
                                <div class="info-row"><div class="info-label">Pojazd Zastępczy:</div><div class="info-value">Toyota Yaris Comfort (Klasa B)</div></div>
                                <div class="info-row"><div class="info-label">Rejestracja:</div><div class="info-value"><span class="reg-badge">WA 12345</span></div></div>
                                <div style="border-top:1px solid var(--border-light); margin:15px 0;"></div>
                                <div class="info-row"><div class="info-label">Data Wydania:</div><div class="info-value">01.03.2026 10:00</div></div>
                                <div class="info-row"><div class="info-label">Licznik (Start):</div><div class="info-value">145 200 km</div></div>
                                <div class="info-row"><div class="info-label">Paliwo (Start):</div><div class="info-value">16/16 (Pełny)</div></div>
                                <div class="info-row"><div class="info-label">Uszkodzenia (Start):</div><div class="info-value">Rysa na tylnym zderzaku</div></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-clock-rotate-left"></i> Dziennik Zdarzeń Najmu (Timeline)</div>
                            <div class="card-body">
                                <div class="card-timeline" id="vehicleTimeline">
                                    <div class="card-tl-item">
                                        <span class="card-tl-cat cat-inne" style="background:#e0e7ff; color:#3730a3;">Wydanie</span>
                                        <div style="font-weight:700;">Wydanie pojazdu klientowi <span style="float:right; font-size:11px; color:var(--text-muted)">01.03.2026</span></div>
                                        <div style="font-size:12.5px; margin-top:5px;">Pojazd wydany zgodnie z umową. Zabezpieczono zdjęcia i protokół.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div class="right-col">
                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-money-bills"></i> Finanse i Rozliczenie</div>
                            <div class="card-body">
                                <div class="info-row">
                                    <div class="info-label">Stawka umowna:</div>
                                    <div class="info-value" style="font-size:16px;">
                                        <span id="displayRate">150,00</span> PLN / Doba
                                        <button class="btn btn-secondary btn-small" style="margin-left: 8px; padding: 3px 8px;" title="Zmień stawkę" onclick="openRateModal()"><i class="fa-solid fa-pen"></i></button>
                                    </div>
                                </div>
                                <div class="info-row"><div class="info-label">Kaucja:</div><div class="info-value">Brak (Rozliczenie bezgotówkowe)</div></div>
                                <div class="info-row">
                                    <div class="info-label">Planowany zwrot:</div>
                                    <div class="info-value">
                                        <span id="displayReturnDate">15.03.2026</span>
                                        <button class="btn btn-secondary btn-small" style="margin-left: 8px; padding: 3px 8px;" title="Aktualizuj datę zwrotu" onclick="openReturnDateModal()"><i class="fa-solid fa-pen"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Podgląd kar dla tego najmu -->
                        <div class="card">
                            <div class="card-header" style="color:var(--warning); background:#fffbeb;"><i class="fa-solid fa-triangle-exclamation"></i> Kary Umowne (Aktywne)</div>
                            <div class="card-body" style="padding: 15px;">
                                <ul style="font-size:12px; color:var(--text-muted); padding-left: 20px;">
                                    <li>Zgubienie kluczyka: 1000 zł</li>
                                    <li>Brak dowodu/polisy: 500 zł</li>
                                    <li>Brudne auto: 70-350 zł</li>
                                    <li>Brak paliwa: Koszt + 30 zł</li>
                                    <li>Palenie papierosów: 500 zł</li>
                                    <li>Zwierzęta bez klatki: 300 zł</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-clock"></i> Notatki operacyjne</div>
                            <div class="card-body">
                                <textarea rows="4" class="creator-input" placeholder="Dodaj notatkę do trwającego najmu (np. klient dzwonił o przedłużenie)..."></textarea>
                                <button class="btn btn-primary btn-small" style="margin-top:10px; width:100%; justify-content:center;">Zapisz Notatkę</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WIDOK 3: WŁAŚCIWY KREATOR WYNAJMU (BEZ ZAKŁADEK FLOTY) -->
            <div id="view-form" class="view-panel">
                
                <div class="header-actions">
                    <div class="page-title"><i class="fa-solid fa-file-signature" style="color:var(--accent-blue)"></i> Kreator Umowy Najmu i Wydania Pojazdu</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary" onclick="toggleViews('view-list')"><i class="fa-solid fa-xmark"></i> Anuluj</button>
                        <button class="btn btn-secondary" onclick="alert('Generowanie 3 plików PDF (Umowa, Oświadczenie, RODO)...')"><i class="fa-solid fa-print"></i> Generuj PDF</button>
                        <button class="btn btn-success" onclick="submitRental()"><i class="fa-solid fa-check"></i> Zatwierdź Wydanie (Zapisz)</button>
                    </div>
                </div>

                <div class="form-erp-card" style="background: white; border-color: var(--border-color); color: var(--text-main); box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 30px;">
                    
                    <!-- Przełącznik Kontekstu -->
                    <div class="context-switch">
                        <label class="context-label" onclick="toggleContext('szkoda')"><input type="radio" name="rentContext" value="szkoda" checked> Wynajem z OC Sprawcy (Szkoda)</label>
                        <label class="context-label" onclick="toggleContext('assistance')" style="color: var(--warning); border: 1px solid var(--warning); padding: 4px 8px; border-radius: 6px; background: #fffbeb;"><input type="radio" name="rentContext" value="assistance"> Wynajem z Assistance (Z Polisy Klienta)</label>
                        <label class="context-label" onclick="toggleContext('naprawa')"><input type="radio" name="rentContext" value="naprawa"> Wynajem przy naprawie mechanicznej</label>
                        <label class="context-label" onclick="toggleContext('prywatny')"><input type="radio" name="rentContext" value="prywatny"> Wynajem wolnorynkowy (Prywatny)</label>
                    </div>

                    <!-- Sekcja 1: Dane Najemcy -->
                    <div class="card" style="box-shadow: none; border-color: #cbd5e1;">
                        <div class="card-header" style="background: #f8fafc;"><i class="fa-solid fa-user-shield"></i> 1. Dane Najemcy i Kontekst</div>
                        <div class="card-body">
                            
                            <div class="form-grid" id="contextFields">
                                <div class="form-group full-width">
                                    <label class="creator-label required">Powiązanie ze Szkodą / Naprawą w Systemie</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="linkedClaimInput" class="creator-input" placeholder="Nr szkody (Zostanie uzupełniony automatycznie)" readonly style="flex: 1; font-weight: 700; color: var(--accent-blue);">
                                        <button type="button" class="btn btn-primary" onclick="document.getElementById('claimSelectModal').style.display='flex'"><i class="fa-solid fa-magnifying-glass"></i> Wybierz Szkodę z Listy</button>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label class="creator-label">Uszkodzony Pojazd Klienta (Zaciągnięty ze szkody)</label>
                                    <input type="text" id="linkedCarInput" class="creator-input" placeholder="Brak wybranej szkody" readonly>
                                </div>
                            </div>

                            <div class="form-group full-width" id="undrivableSection" style="margin-top: 5px; margin-bottom: 25px; border-top: 1px dashed var(--border-color); padding-top: 15px;">
                                <label style="color: var(--danger); font-size: 14px; font-weight: 800; margin-bottom: 10px; display: block;"><i class="fa-solid fa-ban"></i> Uzasadnienie technologicznej niejezdności pojazdu klienta</label>
                                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">Aby TU uznało najem od dnia dzisiejszego, auto klienta musi stwarzać zagrożenie w ruchu lub nie posiadać prawa do poruszania się po drodze.</p>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="creator-label required">Główny powód wykluczenia z ruchu</label>
                                        <select class="creator-input">
                                            <option value="">-- Wybierz powód --</option>
                                            <option>Stłuczona / pęknięta szyba czołowa</option>
                                            <option>Uszkodzone oświetlenie (Rozbity reflektor/lampa)</option>
                                            <option>Ostre, wystające krawędzie karoserii po zderzeniu</option>
                                            <option>Uszkodzenie układu jezdnego / Urwane koło</option>
                                            <option>Wyciek płynów eksploatacyjnych (olej/chłodnica)</option>
                                            <option>Zatrzymany Dowód Rejestracyjny przez Policję</option>
                                            <option>Brak ważnego badania technicznego</option>
                                            <option>Uszkodzone systemy bezpieczeństwa (Wystrzelone poduszki)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="creator-label required">Zdjęcie dowodowe</label>
                                        <div class="upload-zone" style="padding: 12px; font-size:12px;" onclick="document.getElementById('undrivablePhoto').click()">
                                            <i class="fa-solid fa-camera"></i> Wgraj zdjęcie uszkodzenia
                                            <input type="file" id="undrivablePhoto" style="display:none" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="type-switch">
                                <div class="type-option active" id="btn-osoba" onclick="setClientType('osoba')">Osoba Fizyczna (Prywatnie)</div>
                                <div class="type-option" id="btn-firma" onclick="setClientType('firma')">Firma (Działalność / B2B)</div>
                            </div>

                            <div class="company-box" id="companyFields">
                                <h4 style="color: var(--accent-blue); margin-bottom: 15px; font-size: 14px;"><i class="fa-solid fa-building"></i> Dane Przedsiębiorstwa</h4>
                                <div class="form-grid" style="margin-bottom: 0;">
                                    <div class="form-group"><label class="creator-label required">Pełna Nazwa Firmy</label><input type="text" class="creator-input" placeholder="Z rejestru"></div>
                                    <div class="form-group"><label class="creator-label required">NIP Firmy</label><input type="text" class="creator-input" placeholder="0000000000"></div>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group full-width"><h4 id="rep-title" style="margin-bottom: 0px; font-size: 14px;"><i class="fa-solid fa-user"></i> Dane Najemcy</h4></div>
                                <div class="form-group"><label class="creator-label required" id="nameLabel">Imię i Nazwisko Najemcy</label><input type="text" class="creator-input" placeholder="Jan Kowalski"></div>
                                <div class="form-group">
                                    <label class="creator-label required" id="peselLabel">PESEL</label>
                                    <input type="text" id="peselInput" class="creator-input" placeholder="00000000000">
                                    <label style="display:flex; align-items:center; gap:6px; margin-top:8px; cursor:pointer; font-size:12px; font-weight:600; color:var(--text-muted);">
                                        <input type="checkbox" id="foreignerToggle" onchange="toggleForeigner()" style="width:16px; height:16px; accent-color:var(--accent-blue);"> Obcokrajowiec (Brak PESEL)
                                    </label>
                                </div>
                            </div>

                            <div class="form-grid rep-section" id="group-rep">
                                <div class="form-group full-width"><h4 style="color:var(--success); margin-bottom:0px; font-size:13px;"><i class="fa-solid fa-user-tie"></i> Dane Osoby Reprezentującej / Kierowcy</h4></div>
                                <div class="form-group"><label class="creator-label required">Imię i Nazwisko Reprezentanta</label><input type="text" class="creator-input"></div>
                                <div class="form-group"><label class="creator-label required">PESEL Reprezentanta</label><input type="text" class="creator-input" placeholder="Do egzekucji kar"></div>
                            </div>

                            <div class="form-grid foreigner-box" id="foreignerFields">
                                <div class="form-group"><label class="creator-label required">Numer Paszportu</label><input type="text" class="creator-input" id="passportInput"></div>
                                <div class="form-group"><label class="creator-label required">Numer Karty Pobytu / Inny dok.</label><input type="text" class="creator-input" id="residenceCardInput"></div>
                            </div>

                            <div class="form-grid" style="margin-top: 15px;">
                                <div class="form-group full-width"><label class="creator-label required">Dokładny Adres (Zamieszkania / Siedziby)</label><input type="text" class="creator-input" placeholder="ul. Wiejska 1, 00-001 Warszawa"></div>
                                <div class="form-group"><label class="creator-label required">Numer Prawa Jazdy (Weryfikacja)</label><input type="text" class="creator-input"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sekcja 2: Oświadczenia -->
                    <div class="card" id="purposeSection" style="box-shadow: none; border-color: #cbd5e1;">
                        <div class="card-header"><i class="fa-solid fa-balance-scale"></i> 2. Oświadczenie o Celowości Najmu (Dla Ubezpieczyciela)</div>
                        <div class="card-body">
                            <p style="font-size: 13px; color: var(--danger); margin-bottom: 20px; font-weight: 700;">Zaznacz wszystkie właściwe powody do walki o zwrot kosztów (Wymagane do bezgotówki). Im więcej konkretnych, życiowych powodów wskażemy, tym trudniej TU będzie odmówić.</p>
                            
                            <div class="statement-list">
                                <label class="statement-item"><input type="checkbox" id="check-firma"><div class="statement-content"><div class="statement-title">Pojazd firmowy / Działalność gospodarcza</div><div class="statement-desc">Brak możliwości zastąpienia go innym we flocie firmy.</div><input type="text" class="statement-input creator-input" placeholder="Wpisz do czego wykorzystujesz (np. dowóz towaru)..."></div></label>
                                <label class="statement-item"><input type="checkbox" checked><div class="statement-content"><div class="statement-title">Jedyny pojazd w domu (Uchwała SN)</div><div class="statement-desc">Nie mam możliwości korzystania z komunikacji zbiorowej.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Codzienne dojazdy do pracy</div><div class="statement-desc">Niezbędne do dojazdów, brak dogodnej alternatywy pociąg/autobus.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Dowożenie dzieci</div><div class="statement-desc">Szkoła, przedszkole, lekarz, zajęcia pozaszkolne.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Leczenie / Rehabilitacja (Własna/Dzieci)</div><div class="statement-desc">Częste i niezbędne wizyty w oddalonych placówkach medycznych.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Opieka nad osobą starszą / niepełnosprawną</div><div class="statement-desc">Dowożenie jedzenia, leków, transport na badania członka rodziny.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Codzienne załatwianie spraw życiowych</div><div class="statement-desc">Dojazdy po duże zakupy (brak sklepów w okolicy), sprawy urzędowe.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Brak komunikacji miejskiej / Trudny dojazd</div><div class="statement-desc">Mieszkanie poza miastem, drogi gruntowe, rzadkie kursy autobusów.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Transport zwierząt domowych (np. Psy)</div><div class="statement-desc">Konieczność dojazdu do weterynarza / brak opcji przewozu autobusem.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Planowany wyjazd (Delegacja / Wakacje)</div><div class="statement-desc">Wyjazd zaplanowany i opłacony przed momentem kolizji.</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Konieczność holowania przyczepy</div><div class="statement-desc">Użycie haka holowniczego w celach prywatnych (np. łódź, budowa).</div></div></label>
                                <label class="statement-item"><input type="checkbox"><div class="statement-content"><div class="statement-title">Inny, specyficzny powód</div><input type="text" class="statement-input creator-input" placeholder="Wpisz własne uzasadnienie (np. transport gabarytów)..."></div></label>
                            </div>

                            <div class="form-group full-width" style="margin-top: 25px; border-top: 1px dashed #cbd5e1; padding-top: 25px;">
                                <label style="color: var(--accent-blue); font-size: 14px; font-weight:800;"><i class="fa-solid fa-car-burst"></i> Inne pojazdy w gospodarstwie domowym (Blokada argumentów TU)</label>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom:15px;">Zabezpiecz się przed pytaniem ubezpieczyciela: "Dlaczego poszkodowany nie użył auta współmałżonka?".</p>
                                <div id="otherVehiclesList" class="other-vehicles-list"></div>
                                <button type="button" class="btn btn-secondary btn-small" style="width: max-content; margin-top: 10px;" onclick="addOtherVehicle()"><i class="fa-solid fa-plus"></i> Dodaj inny pojazd rodziny i podaj powód braku dostępu</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sekcja 3: Wybór Pojazdu z Floty -->
                    <div class="card" style="box-shadow: none; border-color: #cbd5e1;">
                        <div class="card-header"><i class="fa-solid fa-car-side"></i> 3. Wybór Pojazdu, Terminy i Stawki</div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label class="creator-label required">Wybierz Pojazd Zastępczy z Floty DTD</label>
                                    <select class="creator-input" style="font-weight: bold; font-size:15px; border-color:var(--accent-blue);">
                                        <option value="" disabled selected>-- Znajdź dostępne auto z floty (Status: Wolny) --</option>
                                        <optgroup label="Klasa B"><option>Toyota Yaris [WA 12345] - Benzyna</option></optgroup>
                                        <optgroup label="Klasa C"><option>Skoda Octavia [GD 88990] - Diesel</option></optgroup>
                                    </select>
                                </div>
                                <div class="form-group"><label class="creator-label required">Data i Godzina Wydania (Start)</label><input type="datetime-local" id="startDate" class="creator-input" required></div>
                                <div class="form-group"><label class="creator-label required">Ostateczna Stawka Umowna (PLN / Doba)</label><input type="number" step="0.01" class="creator-input" placeholder="Wpisz stawkę na umowę" required></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sekcja 4: Przebieg, Paliwo i LPG -->
                    <div class="card" style="box-shadow: none; border-color: #cbd5e1;">
                        <div class="card-header"><i class="fa-solid fa-gas-pump"></i> 4. Protokół Wydania: Przebieg, Paliwo i LPG</div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="creator-label required">Stan Licznika w momencie wydania (km)</label>
                                    <input type="number" class="creator-input" style="font-size:20px; font-weight:800; color:var(--accent-blue);" placeholder="np. 145200" required>
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2;">
                                    <div style="display: flex; justify-content: space-between; align-items:center;">
                                        <label class="creator-label required">Stan Paliwa Głównego (Zbiornik 16-częściowy)</label>
                                        <span id="fuelText" class="fuel-info-value">16/16</span>
                                    </div>
                                    <div class="fuel-wrapper">
                                        <div class="fuel-gauge" id="fuel16">
                                            <div class="fuel-segment" onclick="setFuel16(1)"></div><div class="fuel-segment" onclick="setFuel16(2)"></div><div class="fuel-segment" onclick="setFuel16(3)"></div><div class="fuel-segment" onclick="setFuel16(4)"></div>
                                            <div class="fuel-segment" onclick="setFuel16(5)"></div><div class="fuel-segment" onclick="setFuel16(6)"></div><div class="fuel-segment" onclick="setFuel16(7)"></div><div class="fuel-segment" onclick="setFuel16(8)"></div>
                                            <div class="fuel-segment" onclick="setFuel16(9)"></div><div class="fuel-segment" onclick="setFuel16(10)"></div><div class="fuel-segment" onclick="setFuel16(11)"></div><div class="fuel-segment" onclick="setFuel16(12)"></div>
                                            <div class="fuel-segment" onclick="setFuel16(13)"></div><div class="fuel-segment" onclick="setFuel16(14)"></div><div class="fuel-segment" onclick="setFuel16(15)"></div><div class="fuel-segment" onclick="setFuel16(16)"></div>
                                        </div>
                                        <div class="fuel-labels"><span>Rezerwa</span><span>1/4</span><span>1/2</span><span>3/4</span><span>Full (16)</span></div>
                                        <input type="hidden" id="fuelInput" value="16">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sekcja 5: Schemat uszkodzeń -->
                    <div class="card" style="box-shadow: none; border-color: #cbd5e1;">
                        <div class="card-header"><i class="fa-solid fa-car-burst"></i> 5. Schemat Uszkodzeń i Dokumentacja Foto</div>
                        <div class="card-body">
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 25px; font-weight:600;">Oznacz na schemacie ewentualne uszkodzenia przy wydaniu.</p>
                            <div class="schema-container">
                                <div class="car-map">
                                    <div class="car-windshield"></div><div class="car-roof"></div><div class="car-rear-window"></div>
                                    <div class="car-part p-front-bumper" onclick="openCreatorDamageModal(this, 'Zderzak przedni')">Zd. Przód</div>
                                    <div class="car-part p-hood" onclick="openCreatorDamageModal(this, 'Maska')">Maska</div>
                                    <div class="car-part p-fender-fl" onclick="openCreatorDamageModal(this, 'Błotnik Lewy Przód')">Bł. LP</div>
                                    <div class="car-part p-fender-fr" onclick="openCreatorDamageModal(this, 'Błotnik Prawy Przód')">Bł. PP</div>
                                    <div class="car-part p-door-fl" onclick="openCreatorDamageModal(this, 'Drzwi Lewe Przednie')">Drzwi LP</div>
                                    <div class="car-part p-door-fr" onclick="openCreatorDamageModal(this, 'Drzwi Prawe Przednie')">Drzwi PP</div>
                                    <div class="car-part p-door-rl" onclick="openCreatorDamageModal(this, 'Drzwi Lewe Tylne')">Drzwi LT</div>
                                    <div class="car-part p-door-rr" onclick="openCreatorDamageModal(this, 'Drzwi Prawe Tylne')">Drzwi PT</div>
                                    <div class="car-part p-fender-rl" onclick="openCreatorDamageModal(this, 'Błotnik Lewy Tył')">Bł. LT</div>
                                    <div class="car-part p-fender-rr" onclick="openCreatorDamageModal(this, 'Błotnik Prawy Tył')">Bł. PT</div>
                                    <div class="car-part p-roof-box" onclick="openCreatorDamageModal(this, 'Dach')">Dach</div>
                                    <div class="car-part p-trunk" onclick="openCreatorDamageModal(this, 'Klapa bagażnika')">Klapa Tył</div>
                                    <div class="car-part p-rear-bumper" onclick="openCreatorDamageModal(this, 'Zderzak tylny')">Zd. Tył</div>
                                </div>
                                <div class="damage-list-area">
                                    <label class="creator-label">Notatnik uszkodzeń:</label>
                                    <textarea id="creatorDamageTextArea" class="creator-input" style="flex: 1; min-height: 150px; font-family: monospace;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sekcja 6: KARY UMOWNE Z MOŻLIWOŚCIĄ USUNIĘCIA (ODTWORZONA) -->
                    <div class="card" style="box-shadow: none; border-color: #fde68a;">
                        <div class="card-header" style="background: #fffbeb; color: #b45309;"><i class="fa-solid fa-triangle-exclamation"></i> 6. Kary Umowne (Edytowalne przed wydrukiem)</div>
                        <div class="card-body">
                            <p style="font-size: 12px; color: #92400e; margin-bottom: 15px; font-weight:600;">Poniższa lista zostanie wydrukowana na umowie najmu. Jeśli chcesz pominąć karę dla tego klienta, usuń ją z listy klikając czerwoną ikonę kosza.</p>
                            <div class="penalties-list" id="creatorPenaltiesList">
                                <div class="penalty-item"><span>Zgubienie / zniszczenie kluczyka: <strong>1000 zł</strong> (+ koszty dorobienia)</span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Brak polisy lub dowodu rejestracyjnego: <strong>500 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Zwrot brudnego auta (wymaga prania): <strong>350 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Zatankowanie niewłaściwego paliwa: <strong>1000 zł + Koszty naprawy ASO</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Palenie tytoniu w kabinie: <strong>500 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Udostępnienie auta osobie trzeciej bez zgody DTD: <strong>1000 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Wyjazd poza granice RP bez zgody DTD: <strong>2000 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                                <div class="penalty-item"><span>Zatajenie uszkodzenia (kolizji) auta w trakcie najmu: <strong>1000 zł</strong></span><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- =========================================
                 WIDOK 4: PROTOKÓŁ ZWROTU 
                 ========================================= -->
            <div id="view-return" class="view-panel">
                
                <div class="header-actions">
                    <div class="page-title"><i class="fa-solid fa-car-on-return" style="color:var(--accent-blue)"></i> Protokół Zwrotu Pojazdu i Rozliczenie</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary" onclick="toggleViews('view-details')"><i class="fa-solid fa-xmark"></i> Anuluj</button>
                        <button class="btn btn-primary" onclick="alert('Generowanie Protokołu i Wstępnej Faktury...')"><i class="fa-solid fa-print"></i> Drukuj Dokumenty</button>
                        <button class="btn btn-success" onclick="submitReturn()"><i class="fa-solid fa-lock"></i> Zakończ Najem (Rozlicz)</button>
                    </div>
                </div>

                <div style="max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px;">

                    <label class="bypass-box" id="bypassLabel">
                        <input type="checkbox" id="bypassProtocol" onchange="toggleProtocol()">
                        <span>Odstępuję od spisywania weryfikacji wizualnej i paliwa. (Pojazd wraca prosto na plac floty / do serwisu)</span>
                    </label>

                    <div class="card">
                        <div class="card-header"><i class="fa-solid fa-info-circle"></i> 1. Dane Wynajmu i Przekazanie</div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group"><label class="creator-label">Zwracany Pojazd</label><input type="text" class="creator-input" value="Toyota Yaris [WA 12345]" readonly></div>
                                <div class="form-group"><label class="creator-label">Główny Najemca (Z Umowy)</label><input type="text" class="creator-input" value="Jan Kowalski (PESEL: 80101012345)" readonly></div>
                                <div class="form-group">
                                    <label class="creator-label">Początek Najmu</label>
                                    <input type="text" class="creator-input" id="issueDateString" value="01.03.2026, 10:00" readonly>
                                    <input type="hidden" id="issueDateHidden" value="2026-03-01T10:00:00">
                                    <input type="hidden" id="dailyRateNetto" value="150"> 
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color);">
                                <div class="form-group"><label class="creator-label required">Osoba zdająca pojazd (Klient)</label><input type="text" class="creator-input" placeholder="Imię i Nazwisko" required></div>
                                <div class="form-group"><label class="creator-label required">Osoba przyjmująca pojazd (Serwis)</label><input type="text" class="creator-input" placeholder="Twoje dane" required></div>
                            </div>
                            <div class="form-grid" style="margin-top: 15px;">
                                <div class="form-group"><label class="creator-label required">Data i Godzina Zwrotu</label><input type="datetime-local" class="creator-input" id="returnDate" required onchange="updateReturnSummary()"></div>
                                <div class="form-group">
                                    <label class="creator-label required">Stan Licznika przy zwrocie</label>
                                    <div class="comparison-box">
                                        <i class="fa-solid fa-gauge"></i> Stan przy wydaniu: <strong id="startMileage">145200</strong> km
                                        <span id="mileageDiff" style="margin-left:auto; font-weight:bold; color:var(--accent-blue);"></span>
                                    </div>
                                    <input type="number" id="returnMileage" class="creator-input" placeholder="Wpisz nowy przebieg" required oninput="updateReturnSummary()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="protocolDetails">
                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-gas-pump"></i> 2. Rozliczenie Paliwa i Braki</div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div class="comparison-box"><i class="fa-solid fa-arrow-right-from-bracket"></i> Stan paliwa w momencie wydania klientowi: <strong id="startFuel">16</strong><strong>/16 (Pełny)</strong></div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                        <label class="creator-label required">Stan paliwa przy zwrocie (Kliknij segment)</label>
                                        <span id="retFuelText" class="fuel-info-value">16/16</span>
                                    </div>
                                    <div class="fuel-wrapper" style="padding: 10px;">
                                        <div class="fuel-gauge" id="ret-fuel16">
                                            <div class="fuel-segment" onclick="setRetFuel16(1)"></div><div class="fuel-segment" onclick="setRetFuel16(2)"></div><div class="fuel-segment" onclick="setRetFuel16(3)"></div><div class="fuel-segment" onclick="setRetFuel16(4)"></div>
                                            <div class="fuel-segment" onclick="setRetFuel16(5)"></div><div class="fuel-segment" onclick="setRetFuel16(6)"></div><div class="fuel-segment" onclick="setRetFuel16(7)"></div><div class="fuel-segment" onclick="setRetFuel16(8)"></div>
                                            <div class="fuel-segment" onclick="setRetFuel16(9)"></div><div class="fuel-segment" onclick="setRetFuel16(10)"></div><div class="fuel-segment" onclick="setRetFuel16(11)"></div><div class="fuel-segment" onclick="setRetFuel16(12)"></div>
                                            <div class="fuel-segment" onclick="setRetFuel16(13)"></div><div class="fuel-segment" onclick="setRetFuel16(14)"></div><div class="fuel-segment" onclick="setRetFuel16(15)"></div><div class="fuel-segment" onclick="setRetFuel16(16)"></div>
                                        </div>
                                        <div class="fuel-labels"><span>Rezerwa (0)</span><span>1/4</span><span>1/2</span><span>3/4</span><span>Full (16)</span></div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--danger); display: none; font-weight: bold; background: #fef2f2; padding: 10px; border-radius: 6px; border: 1px solid #fca5a5;" id="fuelWarning">
                                        <i class="fa-solid fa-triangle-exclamation"></i> UWAGA: Brakuje <span id="fuelMissingAmount">0</span>/16 baku paliwa bazowego! Opłata dodana do kar.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><i class="fa-solid fa-car-crash"></i> 3. Nowe Uszkodzenia i Zwrócone Wyposażenie</div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px dashed var(--border-color);">
                                    <label class="checkbox-item"><input type="checkbox" checked> Zwrócono Dowód Rej.</label>
                                    <label class="checkbox-item"><input type="checkbox" checked> Zwrócono Polisę</label>
                                    <label class="checkbox-item"><input type="checkbox" checked> Zwrócono Kluczyk</label>
                                    <label class="checkbox-item"><input type="checkbox" checked> Zwrócono Gaśnicę</label>
                                    <label class="checkbox-item" style="color:var(--danger); font-weight:800;"><input type="checkbox" id="carDirtyCheck" onchange="updateReturnSummary()" style="accent-color:var(--danger);"> Wymaga sprzątania!</label>
                                </div>

                                <div class="comparison-box" style="margin-bottom: 15px; background: #fffbeb; border-color: #fde68a;">
                                    <i class="fa-solid fa-clock-rotate-left" style="color: #d97706;"></i> 
                                    <span>Uszkodzenia znane z dnia wydania: <strong>Błotnik lewy przód - rysa.</strong> (Tego klient nie płaci).</span>
                                </div>
                                
                                <div class="schema-container">
                                    <div class="car-map">
                                        <div class="car-windshield"></div><div class="car-roof"></div><div class="car-rear-window"></div>
                                        <div class="car-part p-front-bumper" onclick="openReturnDamageModal(this, 'Zderzak przedni')">Zd. Przód</div>
                                        <div class="car-part p-hood" onclick="openReturnDamageModal(this, 'Maska')">Maska</div>
                                        <div class="car-part p-fender-fl" onclick="openReturnDamageModal(this, 'Błotnik lewy przód')">Bł. LP</div>
                                        <div class="car-part p-fender-fr" onclick="openReturnDamageModal(this, 'Błotnik prawy przód')">Bł. PP</div>
                                        <div class="car-part p-door-fl" onclick="openReturnDamageModal(this, 'Drzwi lewe przednie')">Drzwi LP</div>
                                        <div class="car-part p-door-fr" onclick="openReturnDamageModal(this, 'Drzwi prawe przednie')">Drzwi PP</div>
                                        <div class="car-part p-door-rl" onclick="openReturnDamageModal(this, 'Drzwi lewe tylne')">Drzwi LT</div>
                                        <div class="car-part p-door-rr" onclick="openReturnDamageModal(this, 'Drzwi prawe tylne')">Drzwi PT</div>
                                        <div class="car-part p-fender-rl" onclick="openReturnDamageModal(this, 'Błotnik lewy tył')">Bł. LT</div>
                                        <div class="car-part p-fender-rr" onclick="openReturnDamageModal(this, 'Błotnik prawy tył')">Bł. PT</div>
                                        <div class="car-part p-roof-box" onclick="openReturnDamageModal(this, 'Dach')">Dach</div>
                                        <div class="car-part p-trunk" onclick="openReturnDamageModal(this, 'Klapa bagażnika')">Klapa Tył</div>
                                        <div class="car-part p-rear-bumper" onclick="openReturnDamageModal(this, 'Zderzak tylny')">Zd. Tył</div>
                                    </div>

                                    <div class="damage-list-area">
                                        <label class="creator-label">Protokół ZWROTU - Nowe uwagi i zniszczenia:</label>
                                        <textarea id="retDamageTextArea" class="creator-input" oninput="updateReturnSummary()" placeholder="Wpisz odręcznie lub zaznacz na schemacie obok." style="flex: 1; font-family: monospace; line-height: 1.5;"></textarea>

                                        <div style="margin-top: 15px;">
                                            <label class="creator-label"><i class="fa-solid fa-camera"></i> Zdjęcia zwróconego pojazdu (Podkładka do obciążeń)</label>
                                            <div class="upload-zone" onclick="document.getElementById('fileUploadReturn').click()">
                                                <i class="fa-solid fa-cloud-arrow-up" style="font-size:24px;"></i>
                                                <div style="font-size: 13px; font-weight: 700; color: var(--text-dark); margin-top:5px;">Wgraj zdjęcia uszkodzeń, brudu, braków</div>
                                                <input type="file" id="fileUploadReturn" multiple style="display: none;" accept="image/*">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- POTRĄCENIA (KARY UMOWNE W PROTOKOLE ZWROTU) -->
                        <div class="card">
                            <div class="card-header" style="background: #fef2f2; color: #b91c1c; border-bottom-color: #fca5a5;"><i class="fa-solid fa-file-invoice-dollar"></i> 4. Naliczenie Kar Umownych i Kosztów Dodatkowych</div>
                            <div class="card-body">
                                <p style="font-size: 12px; color: #991b1b; margin-bottom: 15px; font-weight:700;">Kliknij na karę, aby doliczyć ją do rozliczenia końcowego (lub potrącić z kaucji).</p>
                                
                                <div class="penalties-list" id="retPenaltiesList">
                                    <label class="penalty-item" onclick="togglePenaltyClass(this)">
                                        <input type="checkbox" class="penalty-calc" value="1000"><span>Zgubienie lub zniszczenie kluczyka samochodowego (+ koszty ASO)</span><span class="penalty-price">1000 zł</span>
                                    </label>
                                    <label class="penalty-item" onclick="togglePenaltyClass(this)">
                                        <input type="checkbox" class="penalty-calc" value="500"><span>Brak polisy, dowodu rejestracyjnego lub tablicy rej.</span><span class="penalty-price">500 zł</span>
                                    </label>
                                    <label class="penalty-item" onclick="togglePenaltyClass(this)" id="penaltyDirty">
                                        <input type="checkbox" class="penalty-calc" value="150"><span>Zwrot samochodu mocno zabrudzonego (Wymaga myjni / prania)</span><span class="penalty-price">150 zł</span>
                                    </label>
                                    <label class="penalty-item" onclick="togglePenaltyClass(this)" id="penaltyFuel">
                                        <input type="checkbox" class="penalty-calc" value="50"><span>Opłata manipulacyjna za braki w paliwie (+ rzeczywisty koszt PB/ON doliczany na FV)</span><span class="penalty-price">50 zł</span>
                                    </label>
                                    <label class="penalty-item" onclick="togglePenaltyClass(this)">
                                        <input type="checkbox" class="penalty-calc" value="500"><span>Naruszenie zakazu palenia tytoniu / e-papierosów w pojeździe</span><span class="penalty-price">500 zł</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-dashboard" id="finalSummary">
                        <div style="grid-column: 1 / -1; font-size: 18px; font-weight: 800; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px;">
                            <i class="fa-solid fa-calculator"></i> Podsumowanie Końcowe Wynajmu i Wycena
                        </div>
                        
                        <div class="summary-item">
                            <span class="summary-label">Czas trwania najmu</span>
                            <span class="summary-val highlight" id="sumDays">0 dób</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Przejechany dystans</span>
                            <span class="summary-val highlight" id="sumDistance">0 km</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Rozliczenie Paliw</span>
                            <span class="summary-val" id="sumFuelStatus">Zgodne z wydaniem</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Nowe uszkodzenia</span>
                            <span class="summary-val" id="sumDamageStatus">Brak zgłoszeń</span>
                        </div>

                        <div class="invoice-box">
                            <div>
                                <span style="font-size: 13px; font-weight: 600; opacity: 0.8; display: block; margin-bottom: 5px;">Symulacja Rozliczenia Klienta (Stawka bazowa + Kary)</span>
                                <span style="font-size: 12px; opacity: 0.7;">Baza z umowy: <span id="calcBaseRate">150</span> PLN netto/doba</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="font-size: 13px; opacity: 0.8; display: block; margin-bottom:5px;">Suma NETTO: <strong id="invNetto" style="font-size: 18px; color:white;">0.00 zł</strong></span>
                                <span style="font-size: 14px; opacity: 0.9; display: block; padding-top:5px; border-top:1px solid rgba(255,255,255,0.2);">Suma BRUTTO: <strong id="invBrutto" style="font-size: 26px; color: #a7f3d0;">0.00 zł</strong></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- WSPÓŁDZIELONE MODALE -->
    <div class="modal-overlay" id="claimSelectModal">
        <div class="modal-card" style="width: 800px; max-width: 95vw;">
            <div class="modal-header"><h3 style="color:var(--accent-blue); font-weight:800;"><i class="fa-solid fa-list"></i> Wybierz Szkodę z Bazy ERP</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('claimSelectModal')"></i></div>
            <div class="modal-body" style="padding: 0;">
                <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border-color);">
                    <input type="text" class="creator-input" placeholder="Wyszukaj klienta po nazwisku..." style="width: 100%;">
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <tr style="background: #f1f5f9; border-bottom: 2px solid #e2e8f0; text-transform: uppercase; font-size:11px; font-weight: 700; color: #64748b;">
                        <th style="padding: 12px 20px;">Nr Szkody DTD</th>
                        <th style="padding: 12px 20px;">Klient</th>
                        <th style="padding: 12px 20px;">Auto Klienta</th>
                        <th style="padding: 12px 20px;">Akcja</th>
                    </tr>
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 15px 20px; font-weight: 700;">DTD-2026-090</td>
                        <td style="padding: 15px 20px;">Jan Kowalski</td>
                        <td style="padding: 15px 20px;">Audi A4 (WA 11223)</td>
                        <td style="padding: 15px 20px;"><button class="btn btn-primary btn-small" onclick="selectClaim('DTD-2026-090', 'Audi A4 (WA 11223)')">Wybierz</button></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: ZGŁOSZENIE AWARII PRZEZ KLIENTA (NOWOŚĆ) -->
    <div class="modal-overlay" id="breakdownModal">
        <div class="modal-card">
            <div class="modal-header"><h3 style="color:var(--danger); font-weight:800;"><i class="fa-solid fa-car-burst"></i> Zgłoszenie Awarii / Zdarzenia (Pilne)</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('breakdownModal')"></i></div>
            <div class="modal-body">
                <form id="breakdownForm">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Rodzaj zgłaszanego zdarzenia</label>
                        <select class="creator-input" required>
                            <option value="">-- Wybierz --</option>
                            <option>Awaria mechaniczna (auto nie odpala, usterka na drodze)</option>
                            <option>Kolizja z winy klienta (Szkoda z AC)</option>
                            <option>Kolizja z winy osoby 3 (Nowa szkoda z OC sprawcy)</option>
                            <option>Kradzież pojazdu</option>
                            <option>Przebita opona / inna drobna usterka</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Dokładny opis sytuacji z perspektywy klienta</label>
                        <textarea class="creator-input" rows="3" placeholder="np. Klient zgłasza, że auto zgasło na autostradzie A4 w okolicach MOP Złotniki i nie chce odpalić." required></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="creator-label required">Czy potrzebna laweta?</label>
                            <select class="creator-input" onchange="document.getElementById('towAddressGroup').style.display = this.value === 'tak' ? 'block' : 'none';" required>
                                <option value="nie">Nie</option>
                                <option value="tak">Tak</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="creator-label required">Czy klient potrzebuje nowe auto zast.?</label>
                            <select class="creator-input" required>
                                <option value="nie">Nie</option>
                                <option value="tak">Tak</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="towAddressGroup" style="display:none; margin-top:15px;">
                        <label class="creator-label">Dokładny adres odbioru przez lawetę</label>
                        <input type="text" class="creator-input" placeholder="Wpisz ulicę, miasto, km autostrady lub link GPS">
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('breakdownModal')">Anuluj</button>
                        <button type="submit" class="btn btn-danger"><i class="fa-solid fa-triangle-exclamation"></i> Zapisz i przekaż na Dashboard</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL USZKODZEŃ W KREATORZE (WYDANIE) -->
    <div class="modal-overlay" id="creatorDamageDetailModal">
        <div class="modal-card">
            <div class="modal-header"><h3 style="color:var(--danger); font-weight:800;"><i class="fa-solid fa-car-burst"></i> Szczegóły uszkodzenia przy wydaniu</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('creatorDamageDetailModal')"></i></div>
            <div class="modal-body">
                <div style="font-size: 16px; font-weight: 800; margin-bottom: 15px; color: var(--text-dark);">Zaznaczony element: <span id="crCurrentPartLabel" style="color: var(--accent-blue);">Brak</span></div>
                <label class="creator-label" style="display:block; margin-bottom:8px;">Rodzaj uszkodzenia:</label>
                <div class="chips-container" id="crDamageTypeChips">
                    <div class="chip" onclick="selectChip(this, 'crDamageTypeChips')">Rysa / Zarysowanie</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageTypeChips')">Wgniecenie</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageTypeChips')">Pęknięcie / Odprysk</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageTypeChips')">Otarcie parkingowe</div>
                </div>
                <label class="creator-label" style="display:block; margin-top:20px; margin-bottom:8px;">Umiejscowienie:</label>
                <div class="chips-container" id="crDamageLocationChips">
                    <div class="chip" onclick="selectChip(this, 'crDamageLocationChips')">Lewa strona</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageLocationChips')">Prawa strona</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageLocationChips')">Na środku</div>
                    <div class="chip" onclick="selectChip(this, 'crDamageLocationChips')">Dół / Góra</div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="creator-label">Uwagi odręczne</label>
                    <input type="text" id="crDamageCustomNote" class="creator-input" placeholder="np. uszkodzenie zamalowane zaprawką...">
                </div>
                <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                    <button type="button" class="btn btn-secondary" onclick="cancelCreatorDamageSelection()">Anuluj / Usuń zaznaczenie</button>
                    <button type="button" class="btn btn-danger" onclick="saveCreatorDamageDetails()">Zapisz na schemacie</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL USZKODZEŃ W PROTOKOLE (ZWROT) -->
    <div class="modal-overlay" id="returnDamageDetailModal">
        <div class="modal-card">
            <div class="modal-header"><h3 style="color:var(--danger); font-weight:800;"><i class="fa-solid fa-car-burst"></i> Zgłoś NOWE uszkodzenie przy zwrocie</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('returnDamageDetailModal')"></i></div>
            <div class="modal-body">
                <div style="font-size: 16px; font-weight: 800; margin-bottom: 15px; color: var(--text-dark);">Zaznaczony element: <span id="retCurrentPartLabel" style="color: var(--accent-blue);">Brak</span></div>
                <label class="creator-label" style="display:block; margin-bottom:8px;">Rodzaj powstania:</label>
                <div class="chips-container" id="retDamageTypeChips">
                    <div class="chip" onclick="selectChip(this, 'retDamageTypeChips')">Rysa / Otarcie</div>
                    <div class="chip" onclick="selectChip(this, 'retDamageTypeChips')">Wgniecenie ostre</div>
                    <div class="chip" onclick="selectChip(this, 'retDamageTypeChips')">Pęknięcie zderzaka/lampy</div>
                    <div class="chip" onclick="selectChip(this, 'retDamageTypeChips')">Brak elementu (np. kołpak)</div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="creator-label">Szczegóły opisowe (Dowód do obciążeń)</label>
                    <input type="text" id="retDamageCustomNote" class="creator-input" placeholder="np. wyraźne ślady obcego lakieru...">
                </div>
                <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
                    <button type="button" class="btn btn-secondary" onclick="cancelReturnDamageSelection()">Anuluj / Usuń zaznaczenie</button>
                    <button type="button" class="btn btn-danger" onclick="saveReturnDamageDetails()">Zapisz jako NOWĄ Szkodę</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ZMIANA STAWKI (NOWOŚĆ) -->
    <div class="modal-overlay" id="rateModal">
        <div class="modal-card" style="max-width: 480px;">
            <div class="modal-header"><h3 style="color:var(--warning); font-weight:800;"><i class="fa-solid fa-money-bill-trend-up"></i> Aktualizacja Stawki Umownej</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('rateModal')"></i></div>
            <div class="modal-body">
                <form id="rateForm">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Nowa stawka (PLN / Doba Netto)</label>
                        <input type="number" id="new_rate_val" step="0.01" required class="creator-input" placeholder="np. 160.00">
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Z jakiego powodu zmieniasz stawkę?</label>
                        <select id="new_rate_reason" required class="creator-input" onchange="document.getElementById('rate_justification_group').style.display = this.value === 'odmowa_tu' ? 'block' : 'none'; document.getElementById('new_rate_justification').required = this.value === 'odmowa_tu';">
                            <option value="">-- Wybierz przyczynę --</option>
                            <option value="odmowa_tu">Ubezpieczyciel odmówił zgody (najem nadal zasadny)</option>
                            <option value="rabat">Udzielenie rabatu klientowi</option>
                            <option value="aneks">Podpisanie nowego aneksu z klientem</option>
                        </select>
                    </div>
                    <div class="form-group" id="rate_justification_group" style="display:none; margin-bottom:15px;">
                        <label class="creator-label required">Dlaczego najem pozostaje zasadny? (Dla TU)</label>
                        <textarea id="new_rate_justification" class="creator-input" placeholder="Wpisz argumentację merytoryczną, dlaczego podtrzymujemy najem pomimo braku zgody TU..."></textarea>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('rateModal')">Anuluj</button>
                        <button type="submit" class="btn btn-warning">Zatwierdź Stawkę</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: ZMIANA DATY ZWROTU (NOWOŚĆ) -->
    <div class="modal-overlay" id="returnDateModal">
        <div class="modal-card" style="max-width: 480px;">
            <div class="modal-header"><h3 style="color:var(--accent-blue); font-weight:800;"><i class="fa-regular fa-calendar-plus"></i> Aktualizacja Planowanego Zwrotu</h3><i class="fa-solid fa-xmark" style="cursor:pointer;" onclick="closeModal('returnDateModal')"></i></div>
            <div class="modal-body">
                <form id="returnDateForm">
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Nowa planowana data zwrotu</label>
                        <input type="date" id="new_ret_date_val" required class="creator-input">
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label required">Przyczyna przedłużenia / zmiany</label>
                        <select id="new_ret_date_reason" required class="creator-input">
                            <option value="">-- Wybierz przyczynę --</option>
                            <option value="Zgoda ubezpieczyciela">Zgoda ubezpieczyciela na dalszy najem</option>
                            <option value="Przedłużenie naprawy">Przedłużenie naprawy w serwisie (np. ukryte wady)</option>
                            <option value="Oczekiwanie na części">Oczekiwanie na części zamienne</option>
                            <option value="Życzenie klienta">Decyzja klienta (kontynuacja prywatna)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label class="creator-label">Notatka (Opcjonalnie)</label>
                        <textarea id="new_ret_date_note" class="creator-input" placeholder="Dodatkowe informacje dla działu rozliczeń..."></textarea>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('returnDateModal')">Anuluj</button>
                        <button type="submit" class="btn btn-primary">Zapisz Datę</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SKRYPTY INTERAKCJI -->
    <script>
        // Global Variables
        let retCurrentFuel = 16;
        let retDamageData = {}; 
        
        function toggleContext(context) {
            const contextFields = document.getElementById('contextFields');
            const purposeSection = document.getElementById('purposeSection');
            if (context === 'prywatny') {
                contextFields.classList.add('hidden-section');
                purposeSection.classList.add('hidden-section');
            } else if (context === 'naprawa') {
                contextFields.classList.remove('hidden-section');
                purposeSection.classList.add('hidden-section'); 
            } else {
                contextFields.classList.remove('hidden-section');
                purposeSection.classList.remove('hidden-section'); 
            }
        }

        // --- NAWIGACJA GŁÓWNA ---
        function toggleSubmenu(id) {
            const submenu = document.getElementById(id);
            const icon = document.getElementById('icon-' + id.replace('submenu-', ''));
            if (submenu.style.display === "none") {
                submenu.style.display = "block";
                if(icon) icon.style.transform = "rotate(180deg)";
            } else {
                submenu.style.display = "none";
                if(icon) icon.style.transform = "rotate(0deg)";
            }
        }

        function toggleViews(viewId) {
            document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if(viewId === 'view-return') {
                updateReturnSummary(); // Inicjalizacja podsumowania
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- ZGŁOSZENIE AWARII PRZEZ KLIENTA ---
        function openBreakdownModal() {
            document.getElementById('breakdownModal').style.display = 'flex';
        }

        document.getElementById('breakdownForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert("Zgłoszenie awarii zapisane! Pilne zadanie zostało automatycznie przekazane na Twój Dashboard. Status najmu zmieniony.");
            closeModal('breakdownModal');
            // Opcjonalnie: odświeżenie karty detali lub powrót do listy.
        });

        // --- OBSŁUGA WIDOKÓW DETALI I FORMULARZA ---
        function showRentDetails(umowaNr) {
            document.getElementById('detail-nr').innerText = umowaNr;
            toggleViews('view-details');
        }

        // --- LOGIKA KREATORA WYNAJMU (Wydanie) ---
        function selectClaim(claimId, carDetails) {
            document.getElementById('linkedClaimInput').value = claimId;
            document.getElementById('linkedCarInput').value = carDetails;
            closeModal('claimSelectModal');
        }

        let crDamageData = {}; 
        const CR_MARKER = "--- Zgłoszone przy wydaniu ---";
        let crCurrentCarElement = null;
        let crCurrentPartName = "";

        function selectChip(chipElement, containerId) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            chipElement.classList.add('active');
        }

        function openCreatorDamageModal(htmlElement, partName) {
            crCurrentCarElement = htmlElement;
            crCurrentPartName = partName;
            if (htmlElement.classList.contains('damaged')) {
                htmlElement.classList.remove('damaged');
                delete crDamageData[partName];
                updateCreatorDamageTextArea();
            } else {
                document.getElementById('crCurrentPartLabel').innerText = partName;
                document.querySelectorAll('#creatorDamageDetailModal .chip').forEach(c => c.classList.remove('active'));
                document.getElementById('crDamageCustomNote').value = '';
                document.getElementById('creatorDamageDetailModal').style.display = 'flex';
            }
        }

        function cancelCreatorDamageSelection() { closeModal('creatorDamageDetailModal'); crCurrentCarElement = null; }

        function saveCreatorDamageDetails() {
            const typeChip = document.querySelector('#crDamageTypeChips .chip.active');
            const locChip = document.querySelector('#crDamageLocationChips .chip.active');
            const customNote = document.getElementById('crDamageCustomNote').value;

            if(!typeChip) { alert("Proszę wybrać rodzaj uszkodzenia!"); return; }

            let desc = typeChip.innerText;
            if(locChip) desc += ` [${locChip.innerText}]`;
            if(customNote) desc += ` - ${customNote}`;

            crCurrentCarElement.classList.add('damaged');
            crDamageData[crCurrentPartName] = desc;
            updateCreatorDamageTextArea();
            closeModal('creatorDamageDetailModal');
        }

        function updateCreatorDamageTextArea() {
            const textarea = document.getElementById('creatorDamageTextArea');
            let manualText = textarea.value.includes(CR_MARKER) ? textarea.value.split(CR_MARKER)[0].trim() : textarea.value;

            if (Object.keys(crDamageData).length === 0) {
                textarea.value = manualText;
                return;
            }
            
            let schemaText = "\n\n" + CR_MARKER + "\n";
            for (const [part, damage] of Object.entries(crDamageData)) {
                schemaText += `• ${part}: ${damage}\n`;
            }
            textarea.value = (manualText ? manualText + schemaText : schemaText.trim());
        }

        // --- LOGIKA PROTOKOŁU ZWROTU ---
        
        // Zmienne z wydania (symulacja danych pobranych z bazy)
        const START_DATE = new Date("2026-03-01T10:00:00");
        const START_MILEAGE = 145200;
        const START_FUEL = 16;
        const DAILY_RATE_NETTO = 150.00;

        document.addEventListener("DOMContentLoaded", () => {
            const returnDateInput = document.getElementById('returnDate');
            if(returnDateInput) {
                const now = new Date();
                // Format to YYYY-MM-DDTHH:mm to work with datetime-local
                returnDateInput.value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0,16);
            }
            
            // Initialization for issuance
            const startInput = document.getElementById('startDate');
            if(startInput) {
                const now = new Date();
                startInput.value = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0,16);
            }
            
            // Define setFuel16/setLpg6 for issuance globally
            window.setFuel16 = function(level) {
                const fuel16Element = document.getElementById('fuel16');
                if(!fuel16Element) return;

                const segments = fuel16Element.children;
                for(let i=0; i<16; i++) {
                    segments[i].className = 'fuel-segment'; 
                    if (i < level) {
                        segments[i].classList.add('active');
                        if (level <= 3) segments[i].classList.add('low'); 
                        else if (level <= 8) segments[i].classList.add('mid'); 
                    }
                }
                document.getElementById('fuelText').innerText = `${level}/16`;
                document.getElementById('fuelInput').value = level;
            };

            window.setLpg6 = function(level) {
                const lpg6Element = document.getElementById('lpg6');
                if(!lpg6Element) return;

                const segments = lpg6Element.children;
                const labels = ["Pusty (0)", "Rezerwa (R)", "1/4", "1/2", "3/4", "Full (4/4)"];
                for(let i=0; i<6; i++) {
                    segments[i].className = 'lpg-segment'; 
                    if (i < level) {
                        segments[i].classList.add('active');
                        if(level === 1) segments[i].classList.add('low'); 
                        else if(level === 2) segments[i].classList.add('mid'); 
                    }
                }
                document.getElementById('lpgText').innerText = labels[level-1];
                document.getElementById('lpgInput').value = level;
            };

            window.setFuel16(16); 
            window.setLpg6(6);    
        });

        function toggleProtocol() {
            const isChecked = document.getElementById('bypassProtocol').checked;
            const detailsSection = document.getElementById('protocolDetails');
            if (isChecked) detailsSection.classList.add('hidden-card');
            else detailsSection.classList.remove('hidden-card');
            updateReturnSummary();
        }

        function setRetFuel16(level) {
            retCurrentFuel = level;
            const segments = document.getElementById('ret-fuel16').children;
            for(let i=0; i<16; i++) {
                segments[i].className = 'fuel-segment'; 
                if (i < level) {
                    segments[i].classList.add('active');
                    if (level <= 3) segments[i].classList.add('low'); 
                    else if (level <= 8) segments[i].classList.add('mid'); 
                }
            }
            document.getElementById('retFuelText').innerText = `${level}/16`;
            
            const missing = START_FUEL - level;
            const warningText = document.getElementById('fuelWarning');
            if(missing > 0) {
                document.getElementById('fuelMissingAmount').innerText = missing;
                warningText.style.display = "block";
            } else {
                warningText.style.display = "none";
            }
            updateReturnSummary();
        }

        const RET_MARKER = "--- NOWE USZKODZENIA ZWROTNE ---";
        let retCurrentCarElement = null;
        let retCurrentPartName = "";

        function openReturnDamageModal(htmlElement, partName) {
            retCurrentCarElement = htmlElement;
            retCurrentPartName = partName;
            if (htmlElement.classList.contains('damaged')) {
                htmlElement.classList.remove('damaged');
                delete retDamageData[partName];
                updateReturnDamageTextArea();
            } else {
                document.getElementById('retCurrentPartLabel').innerText = partName;
                document.querySelectorAll('#returnDamageDetailModal .chip').forEach(c => c.classList.remove('active'));
                document.getElementById('retDamageCustomNote').value = '';
                document.getElementById('returnDamageDetailModal').style.display = 'flex';
            }
        }

        function cancelReturnDamageSelection() { closeModal('returnDamageDetailModal'); retCurrentCarElement = null; }

        function saveReturnDamageDetails() {
            const typeChip = document.querySelector('#retDamageTypeChips .chip.active');
            const customNote = document.getElementById('retDamageCustomNote').value;

            if(!typeChip) { alert("Proszę wybrać rodzaj uszkodzenia!"); return; }

            let desc = typeChip.innerText;
            if(customNote) desc += ` - ${customNote}`;

            retCurrentCarElement.classList.add('damaged');
            retDamageData[retCurrentPartName] = desc;
            updateReturnDamageTextArea();
            closeModal('returnDamageDetailModal');
        }

        function updateReturnDamageTextArea() {
            const textarea = document.getElementById('retDamageTextArea');
            let manualText = textarea.value.includes(RET_MARKER) ? textarea.value.split(RET_MARKER)[0].trim() : textarea.value;

            if (Object.keys(retDamageData).length === 0) {
                textarea.value = manualText;
                updateReturnSummary();
                return;
            }
            
            let schemaText = "\n\n" + RET_MARKER + "\n";
            for (const [part, damage] of Object.entries(retDamageData)) {
                schemaText += `! ${part}: ${damage}\n`;
            }
            textarea.value = (manualText ? manualText + schemaText : schemaText.trim());
            updateReturnSummary();
        }

        let penaltiesTotal = 0;
        function togglePenaltyClass(labelElement) {
            setTimeout(() => {
                const checkbox = labelElement.querySelector('input[type="checkbox"]');
                if(checkbox.checked) labelElement.classList.add('applied');
                else labelElement.classList.remove('applied');
                
                penaltiesTotal = 0;
                document.querySelectorAll('#retPenaltiesList .penalty-calc').forEach(cb => {
                    if (cb.checked) penaltiesTotal += parseInt(cb.value);
                });
                
                updateReturnSummary();
            }, 10);
        }

        function updateReturnSummary() {
            const retDateVal = document.getElementById('returnDate').value;
            let days = 0;
            if(retDateVal) {
                const retDate = new Date(retDateVal);
                const msDiff = retDate - START_DATE;
                if(msDiff > 0) {
                    const hours = msDiff / (1000 * 60 * 60);
                    days = Math.ceil(hours / 24);
                }
            }
            document.getElementById('sumDays').innerText = `${days} pełnych dób`;

            const retMil = parseInt(document.getElementById('returnMileage').value) || 0;
            const diffMil = retMil - START_MILEAGE;
            const milSpan = document.getElementById('mileageDiff');
            const sumMilSpan = document.getElementById('sumDistance');
            
            if(retMil > 0 && diffMil >= 0) {
                milSpan.innerText = `(+ ${diffMil} km)`;
                sumMilSpan.innerText = `${diffMil} km`;
            } else {
                milSpan.innerText = "";
                sumMilSpan.innerText = "Brak danych";
            }

            const bypass = document.getElementById('bypassProtocol').checked;
            let fuelStatText = "Zgodne z wydaniem";
            let fuelWarnClass = false;

            if(!bypass) {
                let msFuel = START_FUEL - retCurrentFuel;
                if(msFuel > 0) {
                    fuelStatText = `Braki! Benzyna: -${msFuel}/16`;
                    fuelWarnClass = true;
                    const penFuel = document.getElementById('penaltyFuel').querySelector('input');
                    if(!penFuel.checked) {
                        penFuel.checked = true;
                        togglePenaltyClass(document.getElementById('penaltyFuel'));
                    }
                }
                
                if(document.getElementById('carDirtyCheck').checked) {
                    const penDirty = document.getElementById('penaltyDirty').querySelector('input');
                    if(!penDirty.checked) {
                        penDirty.checked = true;
                        togglePenaltyClass(document.getElementById('penaltyDirty'));
                    }
                } else {
                    const penDirty = document.getElementById('penaltyDirty').querySelector('input');
                    if(penDirty.checked) {
                        penDirty.checked = false;
                        togglePenaltyClass(document.getElementById('penaltyDirty'));
                    }
                }
            }
            
            const fuelSumEl = document.getElementById('sumFuelStatus');
            fuelSumEl.innerText = fuelStatText;
            if(fuelWarnClass) fuelSumEl.classList.add('warn'); else fuelSumEl.classList.remove('warn');

            const dmgSumEl = document.getElementById('sumDamageStatus');
            const dmgCount = Object.keys(retDamageData).length;
            if(!bypass && dmgCount > 0) {
                dmgSumEl.innerText = `ZNALEZIONO NOWE (${dmgCount})`;
                dmgSumEl.classList.add('warn');
            } else {
                dmgSumEl.innerText = "Brak nowych zgłoszeń";
                dmgSumEl.classList.remove('warn');
            }

            let baseNetto = days * DAILY_RATE_NETTO;
            let finalNetto = baseNetto + penaltiesTotal;
            let finalBrutto = finalNetto * 1.23;

            document.getElementById('invNetto').innerText = `${finalNetto.toFixed(2)} zł`;
            document.getElementById('invBrutto').innerText = `${finalBrutto.toFixed(2)} zł`;
        }

        function submitRental() {
            alert("Akcja zapisana!");
            toggleViews('view-list');
        }

        function submitReturn() {
            alert("Protokół zwrotu zamknięty! Zmiana statusu pojazdu na WOLNY.");
            toggleViews('view-list');
        }

        // --- AKTUALIZACJA STAWKI I DATY ZWROTU (NOWOŚĆ) ---
        function openRateModal() {
            document.getElementById('rateModal').style.display = 'flex';
        }

        document.getElementById('rateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const val = document.getElementById('new_rate_val').value;
            const reasonEl = document.getElementById('new_rate_reason');
            const reasonText = reasonEl.options[reasonEl.selectedIndex].text;
            const justification = document.getElementById('new_rate_justification').value;
            
            document.getElementById('displayRate').innerText = parseFloat(val).toFixed(2).replace('.', ',');
            
            // Dodanie informacji o zmianie stawki do osi czasu
            const tl = document.getElementById('vehicleTimeline');
            if (tl) {
                const div = document.createElement('div');
                div.className = `card-tl-item`;
                div.innerHTML = `<span class="card-tl-cat cat-inne" style="background:#fef3c7; color:#92400e;">Finanse</span>
                                 <div style="font-weight:700; font-size:14px; color:var(--warning);">Zmiana stawki umownej na ${val} PLN <span style="float:right; font-size:11px; font-weight:600; color:var(--text-muted)">Dzisiaj</span></div>
                                 <div style="font-size:12.5px; color:var(--text-muted); margin-top:5px;">Powód: ${reasonText} ${justification ? '<br><br><strong>Uzasadnienie dla TU:</strong> ' + justification : ''}</div>`;
                tl.prepend(div);
            }
            
            closeModal('rateModal');
            this.reset();
            document.getElementById('rate_justification_group').style.display = 'none';
            alert("Stawka umowna została pomyślnie zaktualizowana!");
        });

        function openReturnDateModal() {
            document.getElementById('returnDateModal').style.display = 'flex';
        }

        document.getElementById('returnDateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const dateVal = document.getElementById('new_ret_date_val').value;
            const reason = document.getElementById('new_ret_date_reason').value;
            const note = document.getElementById('new_ret_date_note').value;
            
            const d = new Date(dateVal);
            const formattedDate = d.toLocaleDateString('pl-PL');
            document.getElementById('displayReturnDate').innerText = formattedDate;
            
            // Dodanie wpisu o przedłużeniu daty do osi czasu
            const tl = document.getElementById('vehicleTimeline');
            if (tl) {
                const div = document.createElement('div');
                div.className = `card-tl-item`;
                div.innerHTML = `<span class="card-tl-cat cat-inne" style="background:#e0e7ff; color:#3730a3;">Terminarz</span>
                                 <div style="font-weight:700; font-size:14px; color:var(--accent-blue);">Aktualizacja daty zwrotu: ${formattedDate} <span style="float:right; font-size:11px; font-weight:600; color:var(--text-muted)">Dzisiaj</span></div>
                                 <div style="font-size:12.5px; color:var(--text-muted); margin-top:5px;">Przyczyna: ${reason} ${note ? '<br>Notatka: ' + note : ''}</div>`;
                tl.prepend(div);
            }

            closeModal('returnDateModal');
            this.reset();
            alert("Planowana data zwrotu została zmieniona.");
        });

        // Functions for Creator
        function setClientType(type) {
            document.getElementById('btn-osoba').classList.remove('active');
            document.getElementById('btn-firma').classList.remove('active');
            document.getElementById('btn-' + type).classList.add('active');

            const repTitle = document.getElementById('rep-title');
            const nameLabel = document.getElementById('nameLabel');
            const companyBox = document.getElementById('companyFields');
            const repSection = document.getElementById('group-rep');

            if (type === 'firma') {
                companyBox.classList.add('active');
                repSection.classList.add('active');
                repTitle.innerHTML = '';
                nameLabel.innerText = 'Imię i Nazwisko (Użytkownik z ramienia firmy)';
                document.getElementById('check-firma').checked = true;
            } else {
                companyBox.classList.remove('active');
                repSection.classList.remove('active');
                repTitle.innerHTML = '<i class="fa-solid fa-user"></i> Dane Najemcy';
                nameLabel.innerText = 'Imię i Nazwisko Najemcy';
            }
        }

        function toggleForeigner() {
            const isChecked = document.getElementById('foreignerToggle').checked;
            const foreignerBox = document.getElementById('foreignerFields');
            const peselInput = document.getElementById('peselInput');

            if (isChecked) {
                foreignerBox.classList.add('active');
                peselInput.placeholder = "Brak (Obcokrajowiec)";
                peselInput.disabled = true;
            } else {
                foreignerBox.classList.remove('active');
                peselInput.placeholder = "00000000000";
                peselInput.disabled = false;
            }
        }

        function toggleLpg() {
            const isChecked = document.getElementById('lpgToggle').checked;
            document.getElementById('lpgContainer').style.display = isChecked ? 'block' : 'none';
        }

        function addOtherVehicle() {
            const list = document.getElementById('otherVehiclesList');
            const row = document.createElement('div');
            row.className = 'other-vehicle-row';
            row.innerHTML = `<input type="text" class="creator-input" placeholder="Marka i model (np. Skoda Fabia)" style="width: 250px;"><input type="text" class="creator-input" placeholder="Dlaczego niedostępne? (np. żona dojeżdża nim do pracy na inną zmianę)" style="flex: 1;"><button type="button" class="btn-remove-penalty" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>`;
            list.appendChild(row);
        }

        function toggleSpecialVehicle() {
            const isChecked = document.getElementById('specialVehicleToggle').checked;
            const specialBox = document.getElementById('specialVehicleBox');
            const select = document.getElementById('specialTypeSelect');
            
            if(isChecked) {
                specialBox.classList.add('active');
            } else {
                specialBox.classList.remove('active');
                select.value = "";
                document.getElementById('suggestedNetto').innerText = "0.00 zł";
            }
        }

        const specialRates = {
            "taxi": { net: 250.00, gross: 307.50 },
            "lka": { net: 200.00, gross: 246.00 },
            "laweta": { net: 400.00, gross: 492.00 },
            "chlodnia": { net: 350.00, gross: 430.50 },
            "brygadowka": { net: 250.00, gross: 307.50 },
            "niepelnosprawni": { net: 300.00, gross: 369.00 },
            "bankowoz": { net: 500.00, gross: 615.00 },
            "karawan": { net: 450.00, gross: 553.50 }
        };

        function updateSpecialRates() {
            const type = document.getElementById('specialTypeSelect').value;
            if(type && specialRates[type]) {
                const net = specialRates[type].net.toFixed(2);
                document.getElementById('suggestedNetto').innerText = `${net} zł`;
            }
        }
    </script>
</body>
</html>